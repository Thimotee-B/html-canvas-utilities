(function(c,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(c=typeof globalThis!="undefined"?globalThis:c||self,a(c["html-canvas-utilities"]={}))})(this,function(c){"use strict";function a(i,t){return t.startsWith("--")?getComputedStyle(i).getPropertyValue(t):t}function p(i,t,e){const{offset:s,scale:n,backgroundColor:o,gridColor:l}=e;t.save();const h=20*n,u=Math.round(s.x)%h,d=Math.round(s.y)%h;t.fillStyle=a(i,o),t.fillRect(0,0,i.width,i.height),t.strokeStyle=a(i,l),t.lineWidth=.23*n;for(let r=u;r<i.width;r+=h)t.beginPath(),t.moveTo(r,0),t.lineTo(r,i.height),t.stroke();for(let r=d;r<i.height;r+=h)t.beginPath(),t.moveTo(0,r),t.lineTo(i.width,r),t.stroke();t.restore()}class y{constructor(){this.listeners=[]}addListener(t){this.listeners.push(t)}removeListener(t){this.listeners=this.listeners.filter(e=>e!==t)}notifyListeners(){for(const t of this.listeners)t(this)}}const f={scale:1,offset:new DOMPoint(0,0)};class m extends y{constructor(t,e=f){super();this.canvas=t,this.options=e,this.gestureEvent=!1,this.mouse=new DOMPoint(0,0),this.mouseDown=!1,this.shouldNotify=!0,this.minScale=.1,this.maxScale=10,this.ctx=this.canvas.getContext("2d"),this.transform=this.ctx.getTransform(),this.shouldNotify=!1;const{scale:s,offset:n}=e;this.scale(s),this.pan(n),this.shouldNotify=!0,this.onWheelEvent=this.onWheelEvent.bind(this),t.addEventListener("wheel",this.onWheelEvent,{passive:!1}),this.onMouseDown=this.onMouseDown.bind(this),t.addEventListener("mousedown",this.onMouseDown,!1),this.onMouseMove=this.onMouseMove.bind(this),t.addEventListener("mousemove",this.onMouseMove,!1),this.onMouseUp=this.onMouseUp.bind(this),t.addEventListener("mouseup",this.onMouseUp,!1),this.onTouchStart=this.onTouchStart.bind(this),t.addEventListener("touchstart",this.onTouchStart,!1),this.onTouchMove=this.onTouchMove.bind(this),t.addEventListener("touchmove",this.onTouchMove,!1),this.onTouchEnd=this.onTouchEnd.bind(this),t.addEventListener("touchend",this.onTouchEnd,!1),this.onKeyDownEvent=this.onKeyDownEvent.bind(this),this.onKeyUpEvent=this.onKeyUpEvent.bind(this),document.addEventListener("keydown",this.onKeyDownEvent,!1),document.addEventListener("keyup",this.onKeyUpEvent,!1)}get matrix(){return this.transform}set matrix(t){this.transform=t,this.notify()}notify(){!this.shouldNotify||this.notifyListeners()}localPoint(t){const{scale:e,offset:s}=this.info,n=t.x/e-s.x/e,o=t.y/e-s.y/e;return new DOMPoint(n,o)}applyTransform(t){t.setTransform(this.matrix)}scale(t,e=new DOMPoint(0,0)){if(Number.isNaN(t))return;console.debug("scale",t,e);const s=t*this.info.scale;if(this.options.scale=s,s<this.minScale||s>this.maxScale)return;const n=this.localPoint(e);this.matrix=this.matrix.scale(t,t,0,n.x,n.y,n.z),this.notify()}pan(t){if(Number.isNaN(t))return;const{scale:e}=this.info;console.debug("pan",t),this.options.offset.x+=t.x/e,this.options.offset.y+=t.y/e,this.matrix=this.matrix.translate(t.x/e,t.y/e,t.z/e),this.notify()}get info(){const{scaleX:t,scaleY:e,translateX:s,translateY:n,rotate:o}=v(this.matrix);return{scale:Math.min(t,e),offset:new DOMPoint(s,n),rotation:o,mouse:this.mouse,mouseDown:this.mouseDown}}onWheelEvent(t){if(t.preventDefault(),this.gestureEvent)return;const e=new DOMPoint(t.offsetX,t.offsetY);if(t.ctrlKey){let s=1;t.deltaY<0?s=Math.min(this.maxScale,s*1.1):s=Math.max(this.minScale,s*(1/1.1)),this.scale(s,e)}else this.pan(new DOMPoint(-t.deltaX,-t.deltaY))}onMouseDown(t){this.mouse=new DOMPoint(t.offsetX,t.offsetY),this.mouseDown=!0}onMouseMove(t){this.mouse=new DOMPoint(t.offsetX,t.offsetY)}onMouseUp(t){this.mouse=new DOMPoint(t.offsetX,t.offsetY),this.mouseDown=!1}onTouchStart(t){t.preventDefault(),this.touches=t.touches,this.mouseDown=!0,this.gestureEvent=this.touches.length>1}onTouchMove(t){t.preventDefault();const e=this.touches;if(this.touches=t.touches,this.gestureEvent){if(this.touches.length===2){const s=new DOMPoint((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2),n=new DOMPoint((t.touches[0].clientX+t.touches[1].clientX)/2,(t.touches[0].clientY+t.touches[1].clientY)/2),o=e[0].clientX-e[1].clientX,h=(t.touches[0].clientX-t.touches[1].clientX)/o;if(this.scale(h,n),n!==s){const u=new DOMPoint(n.x-s.x,n.y-s.y);this.pan(u)}}else if(this.touches.length===3){const s=new DOMPoint(Math.min(e[0].clientX,e[1].clientX,e[2].clientX),Math.min(e[0].clientY,e[1].clientY,e[2].clientY)),n=new DOMPoint(Math.min(t.touches[0].clientX,t.touches[1].clientX,t.touches[2].clientX),Math.min(t.touches[0].clientY,t.touches[1].clientY,t.touches[2].clientY)),o=new DOMPoint(n.x-s.x,n.y-s.y);this.pan(o)}}}onTouchEnd(t){t.preventDefault(),this.touches=t.touches,this.mouseDown=this.touches.length===0,this.gestureEvent=this.touches.length>1}onKeyDownEvent(t){t.key==="ArrowLeft"?this.pan(new DOMPoint(-10,0)):t.key==="ArrowRight"?this.pan(new DOMPoint(10,0)):t.key==="ArrowUp"?this.pan(new DOMPoint(0,-10)):t.key==="ArrowDown"?this.pan(new DOMPoint(0,10)):t.key==="="?this.scale(1.1,this.mouse):t.key==="-"&&this.scale(1/1.1,this.mouse)}onKeyUpEvent(t){}}function v(i){const t=(i.a+i.d)/2,e=(i.a-i.d)/2,s=(i.c+i.b)/2,n=(i.c-i.b)/2,o=Math.sqrt(t*t+n*n),l=Math.sqrt(e*e+s*s),h=Math.atan2(s,e),u=Math.atan2(n,t),d=(u-h)/2,r=(u+h)/2;return{translateX:i.e,translateY:i.f,rotate:-r*180/Math.PI,scaleX:o+l,scaleY:o-l,skew:-d*180/Math.PI}}class M extends m{constructor(t,e=f){super(t,e);this.canvas=t,this.options=e,this.children=[],this.selection=[],this.hovered=[],this.canSelect=!0,this.canMove=!0,this.canDelete=!0,this.spacePressed=!1,this.middleClick=!1}drawBackground(){const{offset:t,scale:e}=this.info,{ctx:s,canvas:n}=this;s.fillStyle=a(n,"--canvas-controller-background-color"),s.fillRect(0,0,n.width,n.height),p(n,s,{offset:t,scale:e,backgroundColor:"--canvas-controller-background-color",gridColor:"--canvas-controller-grid-color"})}resize(){const t=this.canvas,e=getComputedStyle(t),{canvas:s}=this;s.width=parseInt(e.width,10),s.height=parseInt(e.height,10)}paint(){const{canvas:t,ctx:e}=this;this.resize(),e.clearRect(0,0,t.width,t.height),this.drawBackground(),this.applyTransform(e),this.drawContent(e),requestAnimationFrame(()=>this.paint())}drawContent(t){for(const e of this.children)t.save(),t.translate(e.rect.x,e.rect.y),e.draw(this.ctx),t.restore(),this.selection.includes(e)?this.drawOutline(t,e.rect,"--canvas-controller-selected-color"):this.hovered.includes(e)&&this.drawOutline(t,e.rect,"--canvas-controller-hovered-color")}drawOutline(t,e,s){const{canvas:n}=this;t.save(),t.strokeStyle=a(n,s),t.strokeRect(e.x,e.y,e.width,e.height),t.restore()}select(t,e=1){const s=this.localPoint(t),n=[],o=Array.from(this.children).reverse();for(const l of o){const h=l.rect;if(s.x>=h.x&&s.x<=h.x+h.width&&s.y>=h.y&&s.y<=h.y+h.height){n.push(l);continue}}return n.slice(0,e)}onMouseDown(t){super.onMouseDown(t),this.canSelect&&this.updateSelection(this.select(this.mouse)),this.middleClick=t.button===1,this.updateCursor()}onMouseUp(t){super.onMouseUp(t),this.canSelect&&this.updateSelection(this.select(this.mouse)),this.middleClick=!1,this.updateCursor()}onMouseMove(t){const e=this.mouse;super.onMouseMove(t),this.hovered=this.select(this.mouse),this.mouseDown&&this.move(new DOMPoint(this.mouse.x-e.x,this.mouse.y-e.y)),this.updateCursor()}onTouchStart(t){if(super.onTouchStart(t),!this.gestureEvent&&this.canSelect){const e=t.touches[0],s=new DOMPoint(e.clientX,e.clientY);this.updateSelection(this.select(s))}}onTouchMove(t){const e=(this.touches||[])[0];if(super.onTouchMove(t),!this.gestureEvent){const s=t.touches[0];this.move(new DOMPoint(s.clientX-e.clientX,s.clientY-e.clientY))}}move(t){if(this.spacePressed||this.middleClick)this.pan(new DOMPoint(t.x,t.y));else if(this.canMove&&this.selection.length>0){const e=this.info.scale;for(const s of this.selection){const n=s.rect;n.x+=t.x/e,n.y+=t.y/e,s.rect=n,this.notify()}}}onKeyDownEvent(t){super.onKeyDownEvent(t),t.key==="Backspace"&&this.removeSelection(),this.spacePressed=t.key===" ",this.updateCursor()}onKeyUpEvent(t){super.onKeyUpEvent(t),this.spacePressed=!1,this.updateCursor()}updateCursor(){const{hovered:t,selection:e,spacePressed:s,canMove:n}=this,o=e.length>0&&e.every(l=>t.includes(l));s||this.middleClick?this.canvas.style.cursor="grab":e.length>0&&o&&n?this.canvas.style.cursor="move":this.canvas.style.cursor="default"}updateSelection(t){this.selection=t,this.notify()}clearSelection(){this.updateSelection([])}removeSelection(){!this.canDelete||(this.children=this.children.filter(t=>!this.selection.includes(t)),this.clearSelection())}addChild(t){this.children.push(t),this.updateSelection([t])}}c.CanvasController=M,c.CanvasTransformer=m,c.Listenable=y,c.color=a,c.defaultOptions=f,c.drawInfiniteGrid=p,Object.defineProperty(c,"__esModule",{value:!0}),c[Symbol.toStringTag]="Module"});
